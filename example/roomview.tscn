[gd_scene load_steps=2 format=2]

[sub_resource type="GDScript" id=2]

script/source = "extends Panel

var client
export(NodePath) var client_path

export(String) var room_id

func _ready():
	if (client_path):
		client = get_node(client_path)
		client.connect(\"ephemeral_event\", self, \"ephemeral_event\")
		client.connect(\"timeline_event\", self, \"timeline_event\")
		client.connect(\"state_event\", self, \"state_event\")

func get_name(user_id):
	return client.get_user(user_id).get_friendly_name(true)

func timeline_event(event):
	if (event['room_id'] == room_id):
		if (event['type'] == \"m.room.message\" and event.has('content') and event['content'].has('body')):
			get_node(\"messages\").text += \"\\n<\"+self.get_name(event['sender'])+\"> \"+event['content']['body']
		elif (event['type'] == \"m.room.name\"):
			get_node(\"messages\").text += \"\\n\"+self.get_name(event['sender'])+\" changed the room name to \"+event['content']['name']
		elif (event['type'] == \"m.room.topic\"):
			get_node(\"messages\").text += \"\\n\"+self.get_name(event['sender'])+\" changed the topic to \"+event['content']['topic']
			

func send_message(text=\"\"):
	if (get_node(\"messagebox\").text != \"\"):
		client.get_rooms()[room_id].send_text_message(get_node(\"messagebox\").text)
		get_node(\"messagebox\").clear()

func ephemeral_event(event):
	if (event['room_id'] == room_id):
		if (event['type'] == \"m.typing\"):
			if (event['content']['user_ids'].size() == 0):
				get_node(\"typing\").text = \"\"
			elif (event['content']['user_ids'].size() == 1):
				get_node(\"typing\").text = event['content']['user_ids'][0] + \" is typing\"
			else:
				var typing_text = String(event['content']['user_ids'])
				typing_text = typing_text.substr(1, typing_text.length()-2)
				
				get_node(\"typing\").text = typing_text + \" are typing\"

func state_event(event):
	if (event['room_id'] == room_id):
		get_node(\"room_name\").set_text(\"Room name: \"+client.get_rooms()[room_id].get_name())
		get_node(\"room_topic\").set_text(\"Topic: \"+client.get_rooms()[room_id].get_topic())"

[node name="Room view" type="Panel"]

anchor_right = 1
anchor_bottom = 1
rect_clip_content = false
mouse_filter = 0
script = SubResource( 2 )
client_path = null
room_id = ""

[node name="messagebox" type="LineEdit" parent="."]

anchor_top = 1
anchor_right = 1
anchor_bottom = 1
margin_left = 20.0
margin_top = 44.0
margin_right = 90.0
margin_bottom = 20.0
rect_clip_content = false
mouse_filter = 0
expand_to_len = false
focus_mode = 2
placeholder_text = "Type a message..."
placeholder_alpha = 0.6
caret_blink = false
caret_blink_speed = 0.65

[node name="send" type="Button" parent="."]

anchor_left = 1
anchor_top = 1
anchor_right = 1
anchor_bottom = 1
margin_left = 80.0
margin_top = 44.0
margin_right = 20.0
margin_bottom = 20.0
rect_clip_content = false
mouse_filter = 0
toggle_mode = false
enabled_focus_mode = 2
shortcut = null
group = null
text = "send"
flat = false

[node name="messages" type="Label" parent="."]

anchor_right = 1
anchor_bottom = 1
margin_left = 20.0
margin_top = 60.0
margin_right = 20.0
margin_bottom = 50.0
rect_clip_content = false
mouse_filter = 2
size_flags_vertical = 0
valign = 2
autowrap = true
percent_visible = 1.0
lines_skipped = 0
max_lines_visible = -1

[node name="typing" type="Label" parent="."]

anchor_top = 1
anchor_right = 1
anchor_bottom = 1
margin_left = 20.0
margin_top = 20.0
margin_right = 20.0
rect_clip_content = false
mouse_filter = 2
size_flags_vertical = 0
percent_visible = 1.0
lines_skipped = 0
max_lines_visible = -1

[node name="room_topic" type="Label" parent="."]

anchor_right = 1
margin_left = 20.0
margin_top = 40.0
margin_right = 20.0
margin_bottom = 60.0
rect_clip_content = false
mouse_filter = 2
size_flags_vertical = 0
percent_visible = 1.0
lines_skipped = 0
max_lines_visible = -1

[node name="room_name" type="Label" parent="."]

anchor_right = 1
margin_left = 20.0
margin_top = 20.0
margin_right = 20.0
margin_bottom = 40.0
rect_clip_content = false
mouse_filter = 2
size_flags_vertical = 0
percent_visible = 1.0
lines_skipped = 0
max_lines_visible = -1

[connection signal="text_entered" from="messagebox" to="." method="send_message"]

[connection signal="pressed" from="send" to="." method="send_message"]


